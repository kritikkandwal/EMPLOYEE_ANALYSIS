<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Productiva - AI Task Manager</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-glow: #00ffff;
            --secondary-glow: #ff00ff;
            --accent-glow: #00ff88;
            --bg-dark: #0a0a0f;
            --bg-card: rgba(255, 255, 255, 0.05);
            --text-primary: #ffffff;
            --text-secondary: #b0b0b0;
            --glass-border: rgba(255, 255, 255, 0.1);
            --glass-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.36);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: var(--bg-dark);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Three.js Background */
        #three-background {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            background: linear-gradient(135deg, #0a0a0f 0%, #1a1a2e 100%);
        }

        .app-container {
            min-height: 100vh;
            display: flex;
        }

        /* Top Bar */
        .top-bar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem 2rem;
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--glass-border);
            z-index: 100;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary-glow), var(--secondary-glow));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .search-container {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .search-box {
            position: relative;
        }

        .search-box input {
            padding: 10px 15px 10px 40px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--glass-border);
            border-radius: 25px;
            color: var(--text-primary);
            width: 300px;
            transition: all 0.3s ease;
        }

        .search-box input:focus {
            outline: none;
            border-color: var(--primary-glow);
            box-shadow: 0 0 10px rgba(0, 255, 255, 0.3);
        }

        .search-box i {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
        }

        .filter-select {
            padding: 10px 15px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--glass-border);
            border-radius: 25px;
            color: var(--text-primary);
            cursor: pointer;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-glow), var(--secondary-glow));
            color: var(--bg-dark);
            border: none;
            padding: 10px 20px;
            border-radius: 25px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 255, 255, 0.4);
        }

        /* Sidebar */
        .sidebar {
            width: 280px;
            height: 100vh;
            background: var(--bg-card);
            backdrop-filter: blur(10px);
            border-right: 1px solid var(--glass-border);
            padding: 80px 1.5rem 1.5rem;
            position: fixed;
            left: 0;
            top: 0;
            overflow-y: auto;
        }

        .sidebar-section {
            margin-bottom: 2rem;
        }

        .sidebar-title {
            font-size: 0.9rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 1rem;
        }

        .progress-container {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .progress-bar {
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-glow), var(--accent-glow));
            border-radius: 3px;
            transition: width 0.5s ease;
        }

        .sprint-item {
            display: flex;
            justify-content: space-between;
            padding: 0.75rem;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 8px;
            margin-bottom: 0.5rem;
        }

        .workload-meter {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            padding: 1rem;
            margin-top: 1rem;
        }

        .workload-status {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        /* Main Content */
        .main-content {
            margin-left: 280px;
            margin-top: 70px;
            padding: 2rem;
            width: calc(100% - 280px);
        }

        .board {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 24px;
        }

        .column {
            background: var(--bg-card);
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 1.5rem;
            box-shadow: var(--glass-shadow);
            transition: all 0.3s ease;
            min-height: 600px;
        }

        .column.drag-over {
            border-color: var(--primary-glow);
            background: rgba(0, 255, 255, 0.05);
        }

        .column:hover {
            transform: translateY(-5px);
            border-color: var(--primary-glow);
        }

        .column-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1.5rem;
        }

        .column-title {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
        }

        .column-badge {
            background: rgba(255, 255, 255, 0.1);
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.8rem;
        }

        .tasks-container {
            min-height: 500px;
        }

        .task-card {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1rem;
            cursor: grab;
            transition: all 0.3s ease;
            position: relative;
            user-select: none;
        }

        .task-card.dragging {
            opacity: 0.5;
            transform: rotate(5deg);
        }

        .task-card:hover {
            transform: translateY(-3px);
            border-color: var(--primary-glow);
            box-shadow: 0 5px 15px rgba(0, 255, 255, 0.2);
        }

        .task-card::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            border-radius: 4px 0 0 4px;
        }

        .task-card.high::before {
            background: #ff4444;
        }

        .task-card.medium::before {
            background: #ffaa00;
        }

        .task-card.low::before {
            background: #00ff88;
        }

        .task-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
        }

        .task-title {
            font-weight: 600;
            font-size: 0.95rem;
        }

        .task-actions {
            display: flex;
            gap: 5px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .task-card:hover .task-actions {
            opacity: 1;
        }

        .task-action-btn {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            width: 24px;
            height: 24px;
            border-radius: 4px;
            color: var(--text-primary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .task-description {
            color: var(--text-secondary);
            font-size: 0.85rem;
            margin-bottom: 10px;
            line-height: 1.4;
        }

        .task-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-bottom: 10px;
        }

        .task-tag {
            background: rgba(255, 255, 255, 0.1);
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 0.75rem;
        }

        .task-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.8rem;
        }

        .task-due {
            display: flex;
            align-items: center;
            gap: 5px;
            color: var(--text-secondary);
        }

        .task-assignee {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
        }

        /* AI Insight */
        .ai-insight {
            background: rgba(0, 255, 255, 0.05);
            border: 1px solid rgba(0, 255, 255, 0.2);
            border-radius: 8px;
            padding: 10px;
            margin-top: 10px;
            font-size: 0.8rem;
            display: none;
        }

        .ai-insight.show {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        .ai-header {
            display: flex;
            align-items: center;
            gap: 5px;
            margin-bottom: 5px;
            color: var(--primary-glow);
        }

        /* Modals */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.show {
            display: flex;
            animation: fadeIn 0.3s ease;
        }

        .modal-content {
            background: var(--bg-card);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 2rem;
            width: 90%;
            max-width: 500px;
            box-shadow: var(--glass-shadow);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .modal-title {
            font-size: 1.25rem;
            font-weight: 600;
        }

        .close-btn {
            background: none;
            border: none;
            color: var(--text-primary);
            font-size: 1.5rem;
            cursor: pointer;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .form-input,
        .form-select,
        .form-textarea {
            width: 100%;
            padding: 10px 15px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--glass-border);
            border-radius: 8px;
            color: var(--text-primary);
            transition: all 0.3s ease;
        }

        .form-input:focus,
        .form-select:focus,
        .form-textarea:focus {
            outline: none;
            border-color: var(--primary-glow);
            box-shadow: 0 0 10px rgba(0, 255, 255, 0.3);
        }

        .form-textarea {
            resize: vertical;
            min-height: 80px;
        }

        .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 1.5rem;
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid var(--glass-border);
            color: var(--text-primary);
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        /* Context Menu */
        .context-menu {
            position: absolute;
            background: var(--bg-card);
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            border-radius: 8px;
            padding: 0.5rem;
            box-shadow: var(--glass-shadow);
            z-index: 100;
            display: none;
        }

        .dropdown {
            position: relative;
            width: 150px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--glass-border);
            border-radius: 8px;
            padding: 10px 15px;
            color: var(--text-primary);
            cursor: pointer;
            user-select: none;
            z-index: 200;
            /* IMPORTANT */
        }

        .dropdown-selected {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .dropdown-menu {
            position: absolute;
            top: 45px;
            left: 0;
            right: 0;
            background: var(--bg-card);
            border: 1px solid var(--glass-border);
            border-radius: 8px;
            padding: 5px 0;
            display: none;
            z-index: 300;
            /* VERY IMPORTANT */
        }

        .dropdown-menu.show {
            display: block;
        }

        .dropdown-item {
            padding: 10px 15px;
            cursor: pointer;
        }

        .dropdown-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }


        .context-menu.show {
            display: block;
            animation: fadeIn 0.2s ease;
        }

        .context-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .context-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .context-item.delete {
            color: #ff4444;
        }

        .logo-link {
            text-decoration: none;
            color: inherit;
            display: inline-flex;
            align-items: center;
        }

        .logo-link:hover {
            opacity: 0.85;
            cursor: pointer;
        }


        /* Animations */
        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        @keyframes slideIn {
            from {
                transform: translateY(-10px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        /* Responsive Design */
        @media (max-width: 1024px) {
            .sidebar {
                width: 240px;
            }

            .main-content {
                margin-left: 240px;
                width: calc(100% - 240px);
            }

            .board {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
        }



        @media (max-width: 480px) {
            .search-container {
                display: none;
            }

            .board {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<body>
    <!-- Three.js Background -->
    <div id="three-background" class="three-background"></div>

    <div class="app-container">
        <!-- Top Bar -->
        <div class="top-bar">
            <a href="{{ url_for('dashboard') }}" class="logo-link">
                <div class="logo">
                    <i class="fas fa-brain"></i>
                    <span>Productiva</span>
                </div>
            </a>


            <div class="search-container">
                <div class="search-box">
                    <i class="fas fa-search"></i>
                    <input type="text" placeholder="Search tasks...">
                </div>

                <div class="dropdown" id="priorityDropdown">
                    <div class="dropdown-selected">All Priorities</div>
                    <div class="dropdown-menu">
                        <div class="dropdown-item" data-value="all">All Priorities</div>
                        <div class="dropdown-item" data-value="high">High</div>
                        <div class="dropdown-item" data-value="medium">Medium</div>
                        <div class="dropdown-item" data-value="low">Low</div>
                    </div>
                </div>


                <button class="btn-primary" id="addTaskBtn">
                    <i class="fas fa-plus"></i>
                    <span>Add Task</span>
                </button>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-section">
                <h3 class="sidebar-title">Productivity Overview</h3>

                <div class="progress-container">
                    <div class="progress-header">
                        <span>Completion</span>
                        <span id="completion-percent">0%</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="completion-bar"></div>
                    </div>
                </div>

                <div class="task-stats">
                    <div class="sprint-item">
                        <span>To Do</span>
                        <span id="todo-count">0</span>
                    </div>
                    <div class="sprint-item">
                        <span>In Progress</span>
                        <span id="inprogress-count">0</span>
                    </div>
                    <div class="sprint-item">
                        <span>Completed</span>
                        <span id="completed-count">0</span>
                    </div>
                </div>
            </div>

            <div class="sidebar-section">
                <h3 class="sidebar-title">Team Analytics</h3>

                <div class="sprint-item">
                    <span>Total Tasks</span>
                    <span id="total-tasks">0</span>
                </div>
                <div class="sprint-item">
                    <span>High Priority</span>
                    <span id="high-priority">0</span>
                </div>
                <div class="sprint-item">
                    <span>Due This Week</span>
                    <span id="due-soon">0</span>
                </div>
            </div>

            <div class="sidebar-section">
                <h3 class="sidebar-title">AI Insights</h3>

                <div class="workload-meter">
                    <div class="workload-status">
                        <span>Team Workload</span>
                        <span id="workload-status" style="color: var(--accent-glow);">Balanced</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="workload-bar"></div>
                    </div>
                </div>

                <div id="ai-recommendation" class="ai-insight" style="display: block; margin-top: 15px;">
                    <div class="ai-header">
                        <i class="fas fa-robot"></i>
                        <span>AI Suggestion</span>
                    </div>
                    <span id="ai-suggestion-text">Add more tasks to get personalized insights</span>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <div class="board">
                <!-- To Do Column -->
                <div class="column" id="todo-column">
                    <div class="column-header">
                        <div class="column-title">
                            <div style="width: 12px; height: 12px; border-radius: 50%; background: #ff4444;"></div>
                            <span>To Do</span>
                            <div class="column-badge" id="todo-badge">0</div>
                        </div>
                    </div>

                    <div class="tasks-container" id="todo-tasks">
                        <!-- Task cards will be added here by JavaScript -->
                    </div>
                </div>

                <!-- In Progress Column -->
                <div class="column" id="inprogress-column">
                    <div class="column-header">
                        <div class="column-title">
                            <div style="width: 12px; height: 12px; border-radius: 50%; background: #ffaa00;"></div>
                            <span>In Progress</span>
                            <div class="column-badge" id="inprogress-badge">0</div>
                        </div>
                    </div>

                    <div class="tasks-container" id="inprogress-tasks">
                        <!-- Task cards will be added here by JavaScript -->
                    </div>
                </div>

                <!-- Completed Column -->
                <div class="column" id="completed-column">
                    <div class="column-header">
                        <div class="column-title">
                            <div style="width: 12px; height: 12px; border-radius: 50%; background: #00ff88;"></div>
                            <span>Completed</span>
                            <div class="column-badge" id="completed-badge">0</div>
                        </div>
                    </div>

                    <div class="tasks-container" id="completed-tasks">
                        <!-- Task cards will be added here by JavaScript -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Task Modal -->
    <div class="modal" id="addTaskModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Create New Task</h2>
                <button class="close-btn" id="closeModal">&times;</button>
            </div>

            <form id="taskForm">
                <div class="form-group">
                    <label class="form-label">Title</label>
                    <input type="text" class="form-input" id="taskTitle" required>
                </div>

                <div class="form-group">
                    <label class="form-label">Description</label>
                    <textarea class="form-textarea" id="taskDescription"></textarea>
                </div>

                <div class="form-group">
                    <label class="form-label">Priority</label>
                    <select class="form-select" id="taskPriority">
                        <option value="low">Low</option>
                        <option value="medium" selected>Medium</option>
                        <option value="high">High</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">Due Date</label>
                    <input type="date" class="form-input" id="taskDueDate">
                </div>

                <div class="form-group">
                    <label class="form-label">Tags (comma separated)</label>
                    <input type="text" class="form-input" id="taskTags" placeholder="design, development, urgent">
                </div>

                <div class="form-actions">
                    <button type="button" class="btn-secondary" id="cancelTask">Cancel</button>
                    <button type="submit" class="btn-primary">Create Task</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Context Menu -->
    <div class="context-menu" id="contextMenu">
        <div class="context-item" id="editTask">
            <i class="fas fa-edit"></i>
            <span>Edit</span>
        </div>
        <div class="context-item delete" id="deleteTask">
            <i class="fas fa-trash"></i>
            <span>Delete</span>
        </div>
    </div>

    <script>
    // ------------------------------
    // TASK STORAGE INIT
    // ------------------------------
    let tasks = JSON.parse(localStorage.getItem('productiva_tasks')) || {
        todo: [
            {
                id: 1,
                title: 'Design new dashboard layout',
                description: 'Create wireframes for the productivity dashboard with glassmorphism effects',
                priority: 'high',
                dueDate: new Date().toISOString().split('T')[0],
                tags: ['design', 'ui'],
                assignee: 'YOU',
                aiInsight: 'Estimated: 3 hours. Consider mobile-first design for better responsiveness.'
            }
        ],
        inprogress: [],
        completed: []
    };

    // ------------------------------
    // SAVE TASKS → LocalStorage + Backend Sync
    // ------------------------------
    function saveTasks() {
        localStorage.setItem('productiva_tasks', JSON.stringify(tasks));
        updateProductivityData();
    }

    // ------------------------------
    // PRODUCTIVITY & TASK SYNC (FIXED)
    // ------------------------------
    function updateProductivityData() {
        const today = new Date().toISOString().split('T')[0];

        const allTasks = getAllTasks();
        const todayTasks = allTasks.filter(task => task.dueDate === today);
        const completedToday = tasks.completed.filter(task => task.dueDate === today).length;

        const productivityScore =
            todayTasks.length > 0 ?
                Math.round((completedToday / todayTasks.length) * 100)
                : 0;

        const productivityData = {
            date: today,
            score: productivityScore,
            level: getProductivityLevel(productivityScore),
            completed: completedToday,
            total: todayTasks.length
        };

        // SAVE LOCALLY
        let productivityHistory = JSON.parse(localStorage.getItem('productivity_history')) || {};
        productivityHistory[today] = productivityData;
        localStorage.setItem('productivity_history', JSON.stringify(productivityHistory));
        localStorage.setItem('current_productivity', JSON.stringify(productivityData));

        // ------------------------------
        // BACKEND UPDATE — PRODUCTIVITY
        // ------------------------------
        fetch("/api/update-productivity", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                date: today,
                completed: completedToday,
                total: todayTasks.length,
                score: productivityScore
            })
        })
            .then(r => r.json())
            .then(res => console.log("BACKEND UPDATED:", res))
            .catch(err => console.error("BACKEND ERROR:", err));

        // ------------------------------
        // BACKEND UPDATE — TASK STATS
        // ------------------------------
        fetch("/api/update-tasks", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                completed: completedToday,
                total: todayTasks.length
            })
        })
            .then(r => r.json())
            .then(res => console.log("TASKS UPDATED:", res))
            .catch(err => console.error("TASK BACKEND ERROR:", err));
    }

    // ------------------------------
    // REDUNDANT FETCH REMOVED (Correct)
    // ------------------------------

    function getProductivityLevel(score) {
        if (score >= 80) return 'HIGH';
        if (score >= 40) return 'MEDIUM';
        return 'LOW';
    }

    function getAllTasks() {
        return [...tasks.todo, ...tasks.inprogress, ...tasks.completed];
    }

    function getTodayDate() {
        return new Date().toISOString().split('T')[0];
    }

    // ------------------------------
    // UI ELEMENT REFERENCES
    // ------------------------------
    const addTaskBtn = document.getElementById('addTaskBtn');
    const addTaskModal = document.getElementById('addTaskModal');
    const closeModal = document.getElementById('closeModal');
    const cancelTask = document.getElementById('cancelTask');
    const taskForm = document.getElementById('taskForm');
    const contextMenu = document.getElementById('contextMenu');
    const editTaskBtn = document.getElementById('editTask');
    const deleteTaskBtn = document.getElementById('deleteTask');

    // ------------------------------
    // INITIALIZE BOARD
    // ------------------------------
    function initializeBoard() {
        addTaskBtn.addEventListener('click', () => {
            document.getElementById('taskDueDate').value = getTodayDate();
            addTaskModal.classList.add('show');
        });

        renderAllTasks();
        updateProductivityOverview();
        updateProductivityData();
    }

    // ------------------------------
    // RENDER TASKS
    // ------------------------------
    function renderAllTasks() {
        document.getElementById('todo-tasks').innerHTML = '';
        document.getElementById('inprogress-tasks').innerHTML = '';
        document.getElementById('completed-tasks').innerHTML = '';

        for (const column in tasks) {
            const container = document.getElementById(`${column}-tasks`);
            tasks[column].forEach(task => {
                container.appendChild(createTaskCard(task, column));
            });
        }

        updateBadgeCounts();
    }

    // ------------------------------
    // CREATE TASK CARD
    // ------------------------------
    function createTaskCard(task, column) {
        const taskCard = document.createElement('div');
        taskCard.className = `task-card ${task.priority}`;
        taskCard.draggable = true;
        taskCard.dataset.taskId = task.id;
        taskCard.dataset.column = column;

        const dueDate = new Date(task.dueDate);
        const formattedDate = dueDate.toLocaleDateString('en-US', {
            month: 'short',
            day: 'numeric'
        });

        const isDueToday = task.dueDate === getTodayDate();
        const todayBadge = isDueToday ? '<span class="today-badge" style="background: #ff4444; color: white; padding: 2px 6px; border-radius: 8px; font-size: 0.7rem; margin-left: 5px;">Today</span>' : '';

        taskCard.innerHTML = `
            <div class="task-header">
                <div class="task-title">${task.title} ${todayBadge}</div>
                <div class="task-actions">
                    <button class="task-action-btn ai-insight-btn">
                        <i class="fas fa-lightbulb"></i>
                    </button>
                    <button class="task-action-btn context-menu-btn">
                        <i class="fas fa-ellipsis-v"></i>
                    </button>
                </div>
            </div>
            <div class="task-description">${task.description}</div>
            <div class="task-tags">
                ${task.tags.map(tag => `<span class="task-tag">${tag}</span>`).join('')}
            </div>
            <div class="ai-insight">
                <div class="ai-header">
                    <i class="fas fa-robot"></i>
                    <span>AI Insight</span>
                </div>
                ${task.aiInsight}
            </div>
            <div class="task-footer">
                <div class="task-due">
                    <i class="far fa-calendar"></i>
                    <span>${formattedDate}</span>
                </div>
                <div class="task-assignee">${task.assignee}</div>
            </div>
        `;

        const aiBtn = taskCard.querySelector('.ai-insight-btn');
        const menuBtn = taskCard.querySelector('.context-menu-btn');
        const aiBox = taskCard.querySelector('.ai-insight');

        aiBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            aiBox.classList.toggle('show');
        });

        menuBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            showContextMenu(e, task, column);
        });

        taskCard.addEventListener('dragstart', handleDragStart);
        taskCard.addEventListener('dragend', handleDragEnd);

        return taskCard;
    }

    // ------------------------------
    // CONTEXT MENU / DRAG DROP
    // ------------------------------
    function showContextMenu(e, task, column) {
        const rect = e.target.getBoundingClientRect();
        contextMenu.style.top = `${rect.bottom + 5}px`;
        contextMenu.style.left = `${rect.left}px`;
        contextMenu.classList.add('show');

        contextMenu.dataset.taskId = task.id;
        contextMenu.dataset.column = column;

        document.addEventListener('click', closeContextMenu);
    }

    function closeContextMenu() {
        contextMenu.classList.remove('show');
        document.removeEventListener('click', closeContextMenu);
    }

    let draggedTaskElement = null;

    function handleDragStart(e) {
        draggedTaskElement = this;
        this.classList.add('dragging');

        e.dataTransfer.setData('text/plain', JSON.stringify({
            taskId: this.dataset.taskId,
            sourceColumn: this.dataset.column
        }));

        e.dataTransfer.effectAllowed = 'move';
    }

    function handleDragEnd() {
        this.classList.remove('dragging');
        draggedTaskElement = null;

        document.querySelectorAll('.column')
            .forEach(col => col.classList.remove('drag-over'));
    }

    document.querySelectorAll('.column').forEach(column => {
        column.addEventListener('dragover', e => {
            e.preventDefault();
            column.classList.add('drag-over');
        });

        column.addEventListener('dragleave', () => {
            column.classList.remove('drag-over');
        });

        column.addEventListener('drop', e => {
            e.preventDefault();
            column.classList.remove('drag-over');

            const data = JSON.parse(e.dataTransfer.getData('text/plain'));
            const taskId = parseInt(data.taskId);
            const sourceColumn = data.sourceColumn;
            const targetColumn = column.id.replace('-column', '');

            if (sourceColumn === targetColumn) return;

            const taskIndex = tasks[sourceColumn].findIndex(t => t.id == taskId);
            const task = tasks[sourceColumn][taskIndex];

            tasks[sourceColumn].splice(taskIndex, 1);
            tasks[targetColumn].push(task);

            saveTasks();

            draggedTaskElement.remove();
            column.querySelector('.tasks-container')
                .appendChild(createTaskCard(task, targetColumn));

            updateBadgeCounts();
            updateProductivityOverview();
        });
    });

    // ------------------------------
    // BADGE COUNTS
    // ------------------------------
    function updateBadgeCounts() {
        document.getElementById('todo-badge').textContent = tasks.todo.length;
        document.getElementById('inprogress-badge').textContent = tasks.inprogress.length;
        document.getElementById('completed-badge').textContent = tasks.completed.length;
    }

    // ------------------------------
    // PRODUCTIVITY OVERVIEW (UI only)
    // ------------------------------
    function updateProductivityOverview() {
        const totalTasks = tasks.todo.length + tasks.inprogress.length + tasks.completed.length;
        const completedTasks = tasks.completed.length;
        const completionPercentage =
            totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;

        document.getElementById('completion-percent').textContent = `${completionPercentage}%`;
        document.getElementById('completion-bar').style.width = `${completionPercentage}%`;

        document.getElementById('todo-count').textContent = tasks.todo.length;
        document.getElementById('inprogress-count').textContent = tasks.inprogress.length;
        document.getElementById('completed-count').textContent = tasks.completed.length;
        document.getElementById('total-tasks').textContent = totalTasks;

        const highPriorityCount =
            [...tasks.todo, ...tasks.inprogress].filter(t => t.priority === 'high').length;

        document.getElementById('high-priority').textContent = highPriorityCount;

        const today = new Date();
        const nextWeek = new Date(today);
        nextWeek.setDate(today.getDate() + 7);

        const dueSoonCount = [...tasks.todo, ...tasks.inprogress]
            .filter(task => {
                const due = new Date(task.dueDate);
                return due >= today && due <= nextWeek;
            }).length;

        document.getElementById('due-soon').textContent = dueSoonCount;

        const workloadPercentage =
            Math.min(100, Math.round((tasks.inprogress.length / Math.max(1, totalTasks)) * 100 * 2));

        document.getElementById('workload-bar').style.width = `${workloadPercentage}%`;

        let workloadStatus = 'Balanced';
        let statusColor = 'var(--accent-glow)';

        if (workloadPercentage > 80) {
            workloadStatus = 'Heavy';
            statusColor = '#ff4444';
        } else if (workloadPercentage > 60) {
            workloadStatus = 'Moderate';
            statusColor = '#ffaa00';
        }

        document.getElementById('workload-status').textContent = workloadStatus;
        document.getElementById('workload-status').style.color = statusColor;

        let aiSuggestion = 'Add more tasks to get personalized insights';

        if (totalTasks === 0) aiSuggestion = 'Start by adding your first task';
        else if (completionPercentage < 30) aiSuggestion = 'Focus on completing tasks';
        else if (completionPercentage > 70) aiSuggestion = 'Great job! Add more challenges';
        else if (highPriorityCount > 3) aiSuggestion = 'Prioritize high-priority tasks';
        else if (dueSoonCount > 0) aiSuggestion = `You have ${dueSoonCount} tasks due soon`;
        else if (tasks.inprogress.length > 4) aiSuggestion = 'Focus on fewer tasks at a time';

        document.getElementById('ai-suggestion-text').textContent = aiSuggestion;
    }

    // ------------------------------
    // ADD TASK MODAL
    // ------------------------------
    addTaskBtn.addEventListener('click', () => {
        addTaskModal.classList.add('show');
    });

    closeModal.addEventListener('click', () => addTaskModal.classList.remove('show'));
    cancelTask.addEventListener('click', () => addTaskModal.classList.remove('show'));

    taskForm.addEventListener('submit', e => {
        e.preventDefault();

        const title = document.getElementById('taskTitle').value;
        const description = document.getElementById('taskDescription').value;
        const priority = document.getElementById('taskPriority').value;
        const dueDate = document.getElementById('taskDueDate').value;
        const tags = document.getElementById('taskTags').value.split(',').map(t => t.trim());

        const newTask = {
            id: Date.now(),
            title,
            description,
            priority,
            dueDate,
            tags,
            assignee: 'You',
            aiInsight: generateAIInsight({ title, description, priority })
        };

        tasks.todo.push(newTask);
        saveTasks();

        document.getElementById('todo-tasks')
            .appendChild(createTaskCard(newTask, 'todo'));

        updateBadgeCounts();
        updateProductivityOverview();

        taskForm.reset();
        addTaskModal.classList.remove('show');
    });

    function generateAIInsight(task) {
        const insights = [
            `Estimated: ${Math.floor(Math.random() * 8) + 2} hours.`,
            `AI Tip: Break into smaller subtasks.`,
            `Urgency: ${task.priority === 'high' ? 'Critical' : task.priority}.`,
            `Plan research first.`,
            `Team load fluctuating — adjust accordingly.`
        ];
        return insights[Math.floor(Math.random() * insights.length)];
    }

    // ------------------------------
    // CONTEXT MENU ACTIONS
    // ------------------------------
    editTaskBtn.addEventListener('click', () => {
        alert(`Edit Task ${contextMenu.dataset.taskId}`);
        closeContextMenu();
    });

    deleteTaskBtn.addEventListener('click', () => {
        const taskId = contextMenu.dataset.taskId;
        const column = contextMenu.dataset.column;

        const idx = tasks[column].findIndex(t => t.id == taskId);
        if (idx !== -1) {
            tasks[column].splice(idx, 1);
            saveTasks();

            const el = document.querySelector(`[data-task-id="${taskId}"]`);
            if (el) el.remove();

            updateBadgeCounts();
            updateProductivityOverview();
        }

        closeContextMenu();
    });

    // ------------------------------
    // BOARD INIT
    // ------------------------------
    document.addEventListener('DOMContentLoaded', initializeBoard);

    // ------------------------------
    // DROPDOWN FILTER (NO CHANGES)
    // ------------------------------
    const dropdown = document.getElementById("priorityDropdown");
    const selected = dropdown.querySelector(".dropdown-selected");
    const menu = dropdown.querySelector(".dropdown-menu");

    dropdown.addEventListener("click", () => {
        menu.classList.toggle("show");
    });

    menu.querySelectorAll(".dropdown-item").forEach(item => {
        item.addEventListener("click", e => {
            const value = e.target.dataset.value;
            selected.textContent = e.target.textContent;
            menu.classList.remove("show");
            filterTasksByPriority(value);
        });
    });

    document.addEventListener("click", e => {
        if (!dropdown.contains(e.target)) {
            menu.classList.remove("show");
        }
    });

    // ------------------------------
    // SEARCH FILTER (NO CHANGES)
    // ------------------------------
    const searchInput = document.querySelector(".search-box input");

    searchInput.addEventListener("input", function () {
        const query = this.value.toLowerCase();

        document.querySelectorAll(".task-card").forEach(card => {
            const title = card.querySelector(".task-title").textContent.toLowerCase();
            const description = card.querySelector(".task-description").textContent.toLowerCase();
            const tags = card.querySelector(".task-tags").textContent.toLowerCase();
            const assignee = card.querySelector(".task-assignee").textContent.toLowerCase();

            const match =
                title.includes(query) ||
                description.includes(query) ||
                tags.includes(query) ||
                assignee.includes(query);

            card.style.display = match ? "block" : "none";
        });
    });

    function filterTasksByPriority(priority) {
        document.querySelectorAll(".task-card").forEach(card => {
            const p =
                card.classList.contains("high") ? "high" :
                card.classList.contains("medium") ? "medium" : "low";

            card.style.display =
                (priority === "all" || p === priority) ? "block" : "none";
        });
    }
</script>

</body>

</html>